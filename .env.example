# ─────────────────────────────────────────────
# 网关服务
# ─────────────────────────────────────────────

# Express 监听端口
PORT=3000

# ─────────────────────────────────────────────
# 平台数据库（easydb_platform）
# 存储网关用户、项目、环境、变量等元数据
# ─────────────────────────────────────────────

DB_HOST=127.0.0.1
DB_PORT=3306
DB_USER=root
DB_PASSWORD=123456
DB_NAME=easydb_platform

# ─────────────────────────────────────────────
# 认证 & JWT
# ─────────────────────────────────────────────

# 是否要求请求携带 Token，关闭后所有接口公开访问（仅开发调试用）
REQUIRE_AUTH=true

# JWT 签名密钥，生产环境必须替换为随机强密钥
JWT_SECRET=replace-with-a-long-random-secret

# JWT 有效期，支持 ms 库格式：8h / 1d / 30m
JWT_EXPIRES_IN=8h

# 可选：统一签发方（多系统统一登录建议配置，验签时也会校验）
# JWT_ISSUER=easydb-auth

# 可选：统一受众（支持逗号分隔多个受众，验签时也会校验）
# JWT_AUDIENCE=easydb-console,easydb-apis

# 认证来源：db = 从数据库验证用户；env = 从 AUTH_USERS 环境变量读取
AUTH_PROVIDER=db

# bcrypt 哈希强度，越高越安全但越慢，推荐 10-14
BCRYPT_ROUNDS=12

# 静态用户列表（AUTH_PROVIDER=env 时生效）
# 格式：username:password_hash_or_plain:role，多个用 ; 分隔
# AUTH_USERS=admin:$2b$12$replace_me:admin;analyst:$2b$12$replace_me:analyst

# ─────────────────────────────────────────────
# SQL 访问策略（旧版 legacy 路由 /api/sql 生效）
# 多项目网关的策略在各项目环境配置中单独管理
# ─────────────────────────────────────────────

# 按角色限制可访问的表，格式：role:table1|table2;role2:*
# * 表示不限制，多个角色用 ; 分隔
ROLE_TABLES=admin:*;analyst:users|orders

# 允许的 SQL 操作类型，逗号分隔：select,insert,update,delete
ALLOWED_SQL_TYPES=select,insert,update,delete

# 允许操作的表名白名单，逗号分隔。留空表示不限制
# ALLOWED_TABLES=users,orders,products

# SELECT 必须携带 LIMIT，防止全表扫描
REQUIRE_SELECT_LIMIT=true

# SELECT LIMIT 最大值，超出会被截断
MAX_SELECT_LIMIT=500

# ─────────────────────────────────────────────
# 限流 & 审计
# ─────────────────────────────────────────────

# 限流时间窗口（毫秒）
RATE_LIMIT_WINDOW_MS=60000

# 时间窗口内单 IP 最大请求数
RATE_LIMIT_MAX=60

# 审计日志查询接口单次最大返回条数
AUDIT_QUERY_MAX_LIMIT=500

# 用户列表查询接口单次最大返回条数
ADMIN_USER_QUERY_MAX_LIMIT=200

# 审计日志写入路径
AUDIT_LOG_FILE=./logs/audit.log

# ─────────────────────────────────────────────
# 请求体加密（AES-256-GCM）
# 前端加密 SQL 请求体，防止中间人篡改
# ─────────────────────────────────────────────

# 是否要求请求体加密
REQUEST_ENCRYPTION_ENABLED=false

# 为 true 时同时接受明文和加密请求（过渡期使用）
REQUEST_ENCRYPTION_ALLOW_PLAINTEXT=true

# 前后端共享的加密密码
REQUEST_ENCRYPTION_PASSWORD=replace-with-shared-password

# ─────────────────────────────────────────────
# 多项目网关
# ─────────────────────────────────────────────

# 旧版 /api/sql 路由对应的默认项目和环境
DEFAULT_PROJECT_KEY=default
DEFAULT_PROJECT_ENV=prod

# 项目配置内存缓存 TTL（毫秒），减少数据库查询
PROJECT_CONFIG_CACHE_TTL_MS=15000

# 项目环境变量的加密密钥（AES-256，32字节 base64url）
# 用于加密存储在数据库中的敏感配置（如数据库密码）
# 生成命令：node -e "console.log(require('crypto').randomBytes(32).toString('base64url'))"
CONFIG_ENCRYPTION_KEY=replace-with-32-char-random-secret

# ─────────────────────────────────────────────
# 平台：新建项目时自动初始化默认环境
# ─────────────────────────────────────────────

# 创建项目时是否自动创建默认环境
PLATFORM_AUTO_CREATE_DEFAULT_ENV=true

# 默认环境标识
PLATFORM_DEFAULT_ENV_KEY=prod

# 默认环境初始状态：active / disabled
PLATFORM_DEFAULT_ENV_STATUS=active

# 默认环境的数据库连接信息（新建项目时预填）
PLATFORM_DEFAULT_DB_HOST=127.0.0.1
PLATFORM_DEFAULT_DB_PORT=3306
PLATFORM_DEFAULT_DB_USER=root
PLATFORM_DEFAULT_DB_PASSWORD=123456

# 数据库名称模板，{projectKey} 和 {env} 会被替换
PLATFORM_DEFAULT_DB_NAME_TEMPLATE={projectKey}_{env}

# 是否自动在目标 MySQL 实例上创建数据库（CREATE DATABASE IF NOT EXISTS）
PLATFORM_AUTO_CREATE_DATABASE=true

# 是否在新建环境时自动建表（通常关闭，由业务方自行管理表结构）
PLATFORM_AUTO_INIT_TABLES=false
# 自动建表的表名列表，逗号分隔（PLATFORM_AUTO_INIT_TABLES=true 时生效）
# PLATFORM_DEFAULT_INIT_TABLES=users,orders,products

# ─────────────────────────────────────────────
# 初始化账号（仅 npm run auth:init 时使用一次）
# ─────────────────────────────────────────────

SEED_ADMIN_USERNAME=admin
SEED_ADMIN_PASSWORD=admin123
SEED_ANALYST_USERNAME=analyst
SEED_ANALYST_PASSWORD=analyst123

# ─────────────────────────────────────────────
# Nginx 配置管理
# 网关自动生成各项目的 Nginx server 配置并热重载
# ─────────────────────────────────────────────

# 是否启用 Nginx 配置自动管理
NGINX_CONFIG_ENABLED=true

# 创建项目/环境时是否自动生成对应的 Nginx 配置文件
NGINX_AUTO_GENERATE_ON_PROJECT_CREATE=true

# Nginx 配置文件输出目录（需挂载到 Nginx 容器的 conf.d）
NGINX_CONF_DIR=./runtime/nginx/conf.d

# 配置文件名模板，{projectKey} 和 {env} 会被替换
NGINX_CONF_FILENAME_TEMPLATE={projectKey}_{env}.conf

# Nginx server_name 模板，每个项目对应一个域名
NGINX_SERVER_NAME_TEMPLATE={projectKey}.local

# Nginx 监听端口
NGINX_LISTEN_PORT=80

# Nginx 默认前端根目录（兜底，通常被项目级配置覆盖）
NGINX_FRONTEND_ROOT=/usr/share/nginx/html

# 是否在项目初始化时自动创建前端目录并写入占位 index.html
NGINX_AUTO_CREATE_FRONTEND_DIR=true

# 前端构建产物在宿主机上的存放路径模板（zip 部署解压到此目录）
NGINX_PROJECT_FRONTEND_DIR_TEMPLATE=./runtime/project-web/{projectKey}/{env}/current

# 对应的 Nginx root 路径（容器内路径，需与 volume 挂载一致）
NGINX_PROJECT_FRONTEND_WEB_ROOT_TEMPLATE=/project-web/{projectKey}/{env}/current

# 网关上游地址（Nginx proxy_pass 目标）
NGINX_UPSTREAM_ORIGIN=http://gateway:3000

# Nginx 热重载命令，配置变更后自动执行
# 示例（Docker 部署）：docker exec easydb-nginx nginx -s reload
NGINX_RELOAD_COMMAND=
